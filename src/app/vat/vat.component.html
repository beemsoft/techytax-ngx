 <div class="container">
 <h1>Btw Aangifte berekenen</h1>

 @if (shellService.licenseStatus() === 'expired') {
  <div class="alert alert-danger d-flex align-items-center mb-4">
    <mat-icon class="mr-2">error</mat-icon>
    <span>
      Je licentie is <strong>verlopen</strong>. De BTW-aangifte functionaliteit is daarom uitgeschakeld.
      Bestaande gegevens blijven gewoon inzichtelijk.
      Activeer een nieuwe licentie in het <a routerLink="/shell/license">Licentie Beheer</a> om weer gebruik te kunnen maken van de BTW-aangifte.
    </span>
  </div>
 } @else if (shellService.licenseStatus() === 'trial') {
  <div class="alert alert-info d-flex align-items-center mb-4">
    <mat-icon class="mr-2">info</mat-icon>
    <div>
      <span>Je gebruikt de proefmodus. De BTW-aangifte blijft functioneel tot het einde van de maand volgend op het huidige kwartaal.</span>
      <div class="small" *ngIf="shellService.trialEndDate()">
        Proefperiode eindigt op: <strong>{{shellService.trialEndDate() | date:'dd-MM-yyyy'}}</strong>
      </div>
    </div>
  </div>
 }

@if (transactionsLoaded() === 0) {
  <mat-card class="mb-4">
    <mat-card-header>
      <mat-card-title>Banktransacties Uploaden</mat-card-title>
    </mat-card-header>
    <mat-card-content class="pt-3">
      <p>
        Je kunt hier je banktransacties uploaden om automatisch je btw-aangifte te berekenen.
        TechyTax ondersteunt momenteel exportbestanden van de volgende banken: <strong>ING</strong> en <strong>ABN AMRO</strong>.
      </p>
      <p>
        De omschrijvingen van de transacties kunnen worden gematcht met specifieke btw-types, waardoor je boekhouding sneller en nauwkeuriger verloopt.
      </p>
      <p>
        Naast het uploaden van banktransacties kun je ook handmatig kosten toevoegen op de <strong>'Kosten'</strong> pagina. Deze handmatige kosten worden automatisch meegenomen in de btw-berekening.
      </p>
      <div class="mt-3">
        <input type="file" (change)="fileChangeEvent($event)" class="form-control" placeholder="Laad transacties..." [disabled]="shellService.licenseStatus() === 'expired'" />
      </div>
    </mat-card-content>
  </mat-card>
}
@if (transactionsLoaded() > 0) {
  <div class="card mb-4">
    <div class="card-body">
      <p class="mb-2">Er zijn {{transactionsLoaded()}} transacties geladen.</p>
      @if (transactionsUnmatched().length > 0) {
        <p class="text-warning mb-0">Er zijn nog {{transactionsUnmatched().length}} onbekende transacties, voeg matches toe.</p>
      } @else {
        <p class="text-success mb-0">Alle transacties zijn gematcht. Loop de onderstaande tabel door om te kijken of alle transacties correct zijn gematch. Je kunt nog een bestand inladen of de fiscale gegevens uploaden met de knop hieronder.</p>
      }
    </div>
  </div>

  <vat-report [vatReport]="vatReport()"></vat-report>
  <button mat-raised-button color="primary" (click)="addManualTransaction()" [disabled]="shellService.licenseStatus() === 'expired'">
      <mat-icon>add</mat-icon> Handmatige match toevoegen
  </button>

  <table mat-table [dataSource]="dataSource()" matSort class="mat-elevation-z8 mt-4">
    <ng-container matColumnDef="date">
      <th mat-header-cell *matHeaderCellDef mat-sort-header="dateFormatted" class="neon-text"> Datum</th>
      <td mat-cell *matCellDef="let transaction" class="neon-text"> {{transaction.dateFormatted}}</td>
    </ng-container>
    <ng-container matColumnDef="description">
      <th mat-header-cell *matHeaderCellDef mat-sort-header class="neon-text"> Omschrijving</th>
      <td mat-cell *matCellDef="let transaction">
        <input type="text" placeholder="beschrijving" [(ngModel)]="transaction.description" class="form-control form-control-sm w-100" [matTooltip]="transaction.description" matTooltipClass="custom-tooltip" [disabled]="shellService.licenseStatus() === 'expired'"/>
        @if (!transaction.costMatch) {
          <div class="mt-2">
            <button mat-stroked-button (click)="match()" size="small" [disabled]="shellService.licenseStatus() === 'expired'">
                <mat-icon>search</mat-icon> Zoek match
            </button>
          </div>
        }
      </td>
    </ng-container>
    <ng-container matColumnDef="matchString">
      <th mat-header-cell *matHeaderCellDef mat-sort-header class="accent-text"> Match</th>
      <td mat-cell *matCellDef="let transaction">
        @if (transaction.costMatch) {
          <div class="d-flex align-items-center">
            <span class="me-2 accent-text">{{transaction.costMatch.matchString}}</span>
            <button mat-icon-button (click)="removeMatch(transaction)" class="action-btn delete-btn" title="Match verwijderen" [disabled]="shellService.licenseStatus() === 'expired'">
              <mat-icon>close</mat-icon>
            </button>
          </div>
        }
        @if (!transaction.costMatch) {
          <div>
            <input type="text" placeholder="matchstring" [(ngModel)]="transaction.matchString" class="form-control form-control-sm mb-2" [disabled]="shellService.licenseStatus() === 'expired'"/>
            <button mat-flat-button color="accent" (click)="addMatch(transaction)" [disabled]="addMatchDisabled(transaction) || shellService.licenseStatus() === 'expired'" size="small">
                <mat-icon>save</mat-icon> Match toevoegen
            </button>
          </div>
        }
      </td>
    </ng-container>
    <ng-container matColumnDef="costType">
      <th mat-header-cell *matHeaderCellDef mat-sort-header="costTypeDescription" class="text-color"> Type</th>
      <td mat-cell *matCellDef="let transaction">
        @if (transaction.costMatch) {
          <div class="text-color">{{transaction.costTypeDescription | label}}</div>
        }
        @if (!transaction.costMatch) {
          <div>
            <select id="costTypes" [(ngModel)]="transaction.costType" class="form-control form-control-sm" [disabled]="shellService.licenseStatus() === 'expired'">
              @for (costType of costTypeList; track costType.key) {
                <option [value]="costType.key">
                  {{costType.value}}
                </option>
              }
            </select>
          </div>
        }
      </td>
    </ng-container>
    <ng-container matColumnDef="costCharacter">
      <th mat-header-cell *matHeaderCellDef mat-sort-header="costCharacterDescription" class="text-color"> Prive/zak.</th>
      <td mat-cell *matCellDef="let transaction">
        @if (transaction.costMatch) {
          <div class="text-color">{{transaction.costCharacterDescription}}</div>
        }
        @if (!transaction.costMatch) {
          <div>
            <select id="costCharacters" [(ngModel)]="transaction.costCharacter" class="form-control form-control-sm" [disabled]="shellService.licenseStatus() === 'expired'">
              @for (costCharacter of costCharacterList; track costCharacter.key) {
                <option [value]="costCharacter.key">
                  {{costCharacter.value}}
                </option>
              }
            </select>
          </div>
        }
      </td>
    </ng-container>
    <ng-container matColumnDef="matchPercentage">
      <th mat-header-cell *matHeaderCellDef mat-sort-header class="accent-text"> Perc.</th>
      <td mat-cell *matCellDef="let transaction">
        @if (transaction.costMatch) {
          <div class="accent-text">{{transaction.costMatch.percentage}}</div>
        }
        @if (!transaction.costMatch) {
          <div><input type="text" placeholder="%" style="width: 50px" [(ngModel)]="transaction.percentage" class="form-control form-control-sm" [disabled]="shellService.licenseStatus() === 'expired'"/></div>
        }
      </td>
    </ng-container>
    <ng-container matColumnDef="matchFixedAmount">
      <th mat-header-cell *matHeaderCellDef mat-sort-header class="accent-text"> Vast bedrag</th>
      <td mat-cell *matCellDef="let transaction">
        @if (transaction.costMatch) {
          <div class="accent-text">{{transaction.costMatch.fixedAmount}}</div>
        }
        @if (!transaction.costMatch) {
          <div><input type="text" style="width: 60px" [(ngModel)]="transaction.fixedAmount" class="form-control form-control-sm" [disabled]="shellService.licenseStatus() === 'expired'"/></div>
        }
      </td>
    </ng-container>
    <ng-container matColumnDef="vatType">
      <th mat-header-cell *matHeaderCellDef mat-sort-header class="text-color"> btw type</th>
      <td mat-cell *matCellDef="let transaction">
        @if (transaction.costMatch) {
          <div class="text-color">{{transaction.costMatch.vatType | label}}</div>
        }
        @if (!transaction.costMatch && displayVatTypeSelector(transaction)) {
          <div>
            <select id="vatTypes" [(ngModel)]="transaction.vatType" class="form-control form-control-sm" [disabled]="shellService.licenseStatus() === 'expired'">
              @for (vatType of vatTypeList; track vatType.key) {
                <option [value]="vatType.key">
                  {{vatType.value}}
                </option>
              }
            </select>
          </div>
        }
      </td>
    </ng-container>
    <ng-container matColumnDef="amount">
      <th mat-header-cell *matHeaderCellDef mat-sort-header="amountFormatted" class="text-color"> Bedrag bruto</th>
      <td mat-cell *matCellDef="let transaction">
        @if (transaction.amount && transaction.costMatch) {
          <div class="text-color font-monospace">{{transaction.amountFormatted}}</div>
        }
        @if (!transaction.amount || !transaction.costMatch) {
          <div><input type="text" placeholder="bedrag" [(ngModel)]="transaction.amount" class="form-control form-control-sm" [disabled]="shellService.licenseStatus() === 'expired'"/></div>
        }
      </td>
    </ng-container>
    <ng-container matColumnDef="amountNet">
      <th mat-header-cell *matHeaderCellDef mat-sort-header class="accent-text"> Bedrag netto</th>
      <td mat-cell *matCellDef="let transaction" class="accent-text font-monospace"> {{transaction.amountNet | currency:'EUR'}}</td>
    </ng-container>
    <ng-container matColumnDef="vatOut">
      <th mat-header-cell *matHeaderCellDef mat-sort-header="amountVat" class="neon-text"> btw uit</th>
      <td mat-cell *matCellDef="let transaction" class="neon-text font-monospace"> {{transaction.amountVat | currency:'EUR'}}</td>
    </ng-container>
    <tr mat-header-row *matHeaderRowDef="columnsToDisplay"></tr>
    <tr mat-row *matRowDef="let row; columns: columnsToDisplay"></tr>
  </table>
}
</div>
