<div class="container">
 <h1>Btw Aangifte berekenen</h1>
@if (transactionsLoaded() === 0) {
  <div>
    <p>
      Bereken hier je btw. Laad eerst een bestand met transacties die je kunt downloaden van je
      online bankieren site of van de OV chipkaart site.
    </p>
  </div>
}
<div>
  <input type="file" (change)="fileChangeEvent($event)" placeholder="Laad transacties..." />
</div>
@if (transactionsLoaded() > 0) {
  <div>
    <p>Er zijn {{transactionsLoaded()}} transacties geladen.</p>
    @if (transactionsUnmatched().length > 0) {
      <div>
        <p>Er zijn nog {{transactionsUnmatched().length}} onbekende transacties, voeg matches toe.</p>
      </div>
    } @else {
      <p>Alle transacties zijn gematcht. Loop de onderstaande tabel door om te kijken of alle transacties correct zijn gematch.  Je kunt nog een bestand inladen of de fiscale gegevens uploaden met de knop hieronder.</p>
    }
  </div>

  <vat-report [vatReport]="vatReport()"></vat-report>
  <button mat-raised-button color="primary" (click)="addManualTransaction()">
      <mat-icon>add</mat-icon> Handmatige match toevoegen
  </button>

  <table mat-table [dataSource]="dataSource()" matSort class="mat-elevation-z8">
    <ng-container matColumnDef="date">
      <th mat-header-cell *matHeaderCellDef mat-sort-header="dateFormatted"> Datum</th>
      <td mat-cell *matCellDef="let transaction"> {{transaction.dateFormatted}}</td>
    </ng-container>
    <ng-container matColumnDef="description">
      <th mat-header-cell *matHeaderCellDef mat-sort-header> Description</th>
      <td mat-cell *matCellDef="let transaction">
        <input type="text" placeholder="beschrijving" [(ngModel)]="transaction.description"/>
        @if (!transaction.costMatch) {
          <div>
            <button mat-stroked-button (click)="match()">
                <mat-icon>search</mat-icon> Zoek match
            </button>
          </div>
        }
      </td>
    </ng-container>
    <ng-container matColumnDef="matchString">
      <th mat-header-cell *matHeaderCellDef mat-sort-header> Match</th>
      <td mat-cell *matCellDef="let transaction">
        @if (transaction.costMatch) {
          <div class="d-flex align-items-center">
            <span class="me-2">{{transaction.costMatch.matchString}}</span>
            <button mat-icon-button (click)="removeMatch(transaction)" class="action-btn delete-btn" title="Match verwijderen">
              <mat-icon>close</mat-icon>
            </button>
          </div>
        }
        @if (!transaction.costMatch) {
          <div>
            <input type="text" placeholder="matchstring" [(ngModel)]="transaction.matchString"/>
            <button mat-flat-button color="accent" (click)="addMatch(transaction)" [disabled]="addMatchDisabled(transaction)">
                <mat-icon>save</mat-icon> Match toevoegen
            </button>
          </div>
        }
      </td>
    </ng-container>
    <ng-container matColumnDef="costType">
      <th mat-header-cell *matHeaderCellDef mat-sort-header="costTypeDescription"> Type</th>
      <td mat-cell *matCellDef="let transaction">
        @if (transaction.costMatch) {
          <div>{{transaction.costTypeDescription | label}}</div>
        }
        @if (!transaction.costMatch) {
          <div>
            <select id="costTypes" [(ngModel)]="transaction.costType">
              @for (costType of costTypeList; track costType.key) {
                <option [value]="costType.key">
                  {{costType.value}}
                </option>
              }
            </select>
          </div>
        }
      </td>
    </ng-container>
    <ng-container matColumnDef="costCharacter">
      <th mat-header-cell *matHeaderCellDef mat-sort-header="costCharacterDescription"> Prive/zak.</th>
      <td mat-cell *matCellDef="let transaction">
        @if (transaction.costMatch) {
          <div>{{transaction.costCharacterDescription}}</div>
        }
        @if (!transaction.costMatch) {
          <div>
            <select id="costCharacters" [(ngModel)]="transaction.costCharacter">
              @for (costCharacter of costCharacterList; track costCharacter.key) {
                <option [value]="costCharacter.key">
                  {{costCharacter.value}}
                </option>
              }
            </select>
          </div>
        }
      </td>

    </ng-container>
    <ng-container matColumnDef="matchPercentage">
      <th mat-header-cell *matHeaderCellDef mat-sort-header> Perc.</th>
      <td mat-cell *matCellDef="let transaction">
        @if (transaction.costMatch) {
          <div>{{transaction.costMatch.percentage}}</div>
        }
        @if (!transaction.costMatch) {
          <div><input type="text" placeholder="%" style="width: 30px" [(ngModel)]="transaction.percentage"/></div>
        }
      </td>
    </ng-container>
    <ng-container matColumnDef="matchFixedAmount">
      <th mat-header-cell *matHeaderCellDef mat-sort-header> Vast bedrag</th>
      <td mat-cell *matCellDef="let transaction">
        @if (transaction.costMatch) {
          <div>{{transaction.costMatch.fixedAmount}}</div>
        }
        @if (!transaction.costMatch) {
          <div><input type="text" style="width: 50px" [(ngModel)]="transaction.fixedAmount"/></div>
        }
      </td>
    </ng-container>
    <ng-container matColumnDef="vatType">
      <th mat-header-cell *matHeaderCellDef mat-sort-header> btw type</th>
      <td mat-cell *matCellDef="let transaction">
        @if (transaction.costMatch) {
          <div>{{transaction.costMatch.vatType | label}}</div>
        }
        @if (!transaction.costMatch && displayVatTypeSelector(transaction)) {
          <div>
            <select id="vatTypes" [(ngModel)]="transaction.vatType">
              @for (vatType of vatTypeList; track vatType.key) {
                <option [value]="vatType.key">
                  {{vatType.value}}
                </option>
              }
            </select>
          </div>
        }
      </td>
    </ng-container>
    <ng-container matColumnDef="amount">
      <th mat-header-cell *matHeaderCellDef mat-sort-header="amountFormatted"> Bedrag bruto</th>
      <td mat-cell *matCellDef="let transaction">
        @if (transaction.amount && transaction.costMatch) {
          <div>{{transaction.amountFormatted}}</div>
        }
        @if (!transaction.amount || !transaction.costMatch) {
          <div><input type="text" placeholder="bedrag" [(ngModel)]="transaction.amount"/></div>
        }
      </td>
    </ng-container>
    <ng-container matColumnDef="amountNet">
      <th mat-header-cell *matHeaderCellDef mat-sort-header> Bedrag netto</th>
      <td mat-cell *matCellDef="let transaction"> {{transaction.amountNet}}</td>
    </ng-container>
    <ng-container matColumnDef="vatOut">
      <th mat-header-cell *matHeaderCellDef mat-sort-header="amountVat"> btw uit</th>
      <td mat-cell *matCellDef="let transaction"> {{transaction.amountVat}}</td>
    </ng-container>
    <tr mat-header-row *matHeaderRowDef="columnsToDisplay"></tr>
    <tr mat-row *matRowDef="let row; columns: columnsToDisplay"></tr>
  </table>
}
</div>
